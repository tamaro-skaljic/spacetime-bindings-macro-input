name: Release SpacetimeDB Bindings Macro Input

on:
  push:
    tags: ["v*"] # Trigger release only on version tags

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Verify tests passed before release
  verify-tests:
    name: Verify tests passed
    runs-on: ubuntu-latest
    steps:
      - name: Wait for test workflow to complete
        uses: actions/github-script@v7
        with:
          script: |
            const tagRef = context.ref;
            const tagSha = context.sha;
            const pollIntervalMs = 5_000; // 5 seconds
            const timeoutMs = 10 * 60_000; // 10 minutes

            console.log(`Waiting for test workflow to pass for tag ${tagRef} (${tagSha})`);

            const startTime = Date.now();

            while (Date.now() - startTime < timeoutMs) {
              const { data: workflows } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'test.yml',
                head_sha: tagSha,
                per_page: 1
              });

              if (workflows.total_count === 0) {
                console.log('‚è≥ No test workflow run found yet, waiting...');
              } else {
                const run = workflows.workflow_runs[0];
                console.log(`Test run status: ${run.status}, conclusion: ${run.conclusion}`);

                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('‚úÖ Tests passed - release can proceed');
                    return;
                  }
                  console.log('‚ùå Tests did not pass - release cannot proceed');
                  process.exit(1);
                }

                console.log('‚è≥ Test workflow still running, waiting...');
              }

              await new Promise(r => setTimeout(r, pollIntervalMs));
            }

            console.log('‚ùå Timed out waiting for test workflow to complete');
            process.exit(1);

  # Release job - publishes to crates.io when version tags are pushed
  release:
    name: Release to crates.io
    runs-on: ubuntu-latest
    needs: verify-tests
    # Use GitHub environment for enhanced security and manual approval if desired
    environment: release
    permissions:
      id-token: write # Required for OIDC token exchange with crates.io
      contents: read # Required to read repository contents

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag (e.g., refs/tags/v0.10.0 -> 0.10.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          echo "üè∑Ô∏è Release triggered by tag: ${{ github.ref }}"

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      # Authenticate with crates.io using OIDC/Trusted Publishing
      - name: Authenticate with crates.io
        id: auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Validate crate publishing readiness
        run: |
          cargo check
          cargo build

      # Publish main crate
      - name: Publish spacetime-bindings-macro-input to crates.io
        run: |
          echo "Publishing spacetime-bindings-macro-input..."
          cargo publish
          echo "‚úÖ spacetime-bindings-macro-input published successfully! üéâ"
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

      # Final verification that spacetime-bindings-macro-input crate is available
      - name: Verify spacetime-bindings-macro-input availability
        uses: ./.github/actions/verify-crate-availability
        with:
          crate-name: spacetime-bindings-macro-input
          version: ${{ steps.version.outputs.version }}
